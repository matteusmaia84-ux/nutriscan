<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NutriScan - Acompanhamento Nutricional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader { border-top-color: #3498db; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .nutrient-card { transition: transform 0.2s; }
        .nutrient-card:hover { transform: translateY(-5px); }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); }
        .progress-bar-fill { transition: width 0.5s ease-in-out; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        
        <header class="flex justify-between items-center mb-6">
            <div class="text-left">
                <h1 class="text-4xl md:text-5xl font-bold text-teal-600">NutriScan</h1>
                <p class="text-gray-600 mt-2">O seu assistente nutricional inteligente.</p>
            </div>
            <div id="auth-container">
                <button id="loginButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">Entrar com Google</button>
                <div id="userInfo" class="hidden items-center">
                    <img id="userPhoto" class="w-10 h-10 rounded-full mr-3" alt="Foto do utilizador">
                    <button id="logoutButton" class="text-sm text-gray-500 hover:text-gray-700">Sair</button>
                </div>
            </div>
        </header>

        <main id="main-content" class="hidden">
            <!-- PAINEL DE METAS DI√ÅRIAS -->
            <div id="dailyGoalsSection" class="bg-white p-6 rounded-2xl shadow-lg mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Resumo de Hoje</h2>
                    <button id="openGoalsModalBtn" class="p-2 text-gray-500 hover:text-teal-600 rounded-full hover:bg-gray-100" title="Definir Metas">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 pointer-events-none" viewBox="0 0 20 20" fill="currentColor">
                           <path d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0L8 7.152l-4.242.618c-1.6.232-2.228 2.18-1.034 3.374L5.65 14.28l-.832 4.226c-.27 1.372 1.244 2.43 2.583 1.76l3.783-1.988 3.783 1.988c1.339.67 2.852-.388 2.583-1.76l-.832-4.226 2.925-2.856c1.194-1.194.566-3.142-1.034-3.374L12 7.152l-.51-3.982zM10 15a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                <div id="goalsProgress" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <!-- Progress bars s√£o inseridas aqui pelo JS -->
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <button id="uploadButton" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 shadow-md">
                        üì∏ Analisar Refei√ß√£o
                    </button>
                     <button id="manualEntryButton" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 shadow-md">
                        ‚úçÔ∏è Adicionar Manualmente
                    </button>
                    <button id="barcodeButton" class="w-full bg-gray-400 text-white font-bold py-3 px-6 rounded-lg shadow-md cursor-not-allowed opacity-75" title="Funcionalidade para o aplicativo m√≥vel (Fase 3)">
                        ‚ùö‚ùö‚ùö Escanear C√≥digo
                    </button>
                </div>
                <input type="file" id="imageUpload" class="hidden" accept="image/*">
                <div id="imagePreviewContainer" class="hidden w-full max-w-md h-64 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center bg-gray-100 mx-auto mt-6">
                    <img id="imagePreview" src="" alt="Pr√©-visualiza√ß√£o da imagem" class="max-h-full max-w-full rounded-md">
                </div>
            </div>

            <div id="loading" class="hidden text-center my-8">
                <!-- ...c√≥digo do loader... -->
            </div>

            <div id="errorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-6" role="alert">
                <!-- ...c√≥digo de mensagem de erro... -->
            </div>

            <div id="results" class="hidden">
                 <!-- Sec√ß√£o de resultados da an√°lise de imagem ser√° inserida aqui -->
            </div>
            
            <div id="historySection" class="mt-12">
                <h2 class="text-2xl font-bold text-center mb-6">O Meu Hist√≥rico de Hoje</h2>
                <div id="historyList" class="space-y-4"></div>
            </div>
        </main>
        
        <div id="login-prompt" class="text-center mt-16 bg-white p-8 rounded-2xl shadow-lg">
             <!-- ...c√≥digo do prompt de login... -->
        </div>
    </div>
    
    <!-- MODALS -->
    <!-- Modal de Metas -->
    <div id="goalsModal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-backdrop flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 m-4 max-w-md w-full shadow-xl">
            <h3 class="text-2xl font-bold mb-4">Definir Metas Di√°rias</h3>
            <div class="space-y-4">
                <div><label for="goalCalories" class="block text-sm font-medium text-gray-700">Calorias (kcal)</label><input type="number" id="goalCalories" class="mt-1 block w-full p-2 border rounded-md"></div>
                <div><label for="goalProtein" class="block text-sm font-medium text-gray-700">Prote√≠nas (g)</label><input type="number" id="goalProtein" class="mt-1 block w-full p-2 border rounded-md"></div>
                <div><label for="goalCarbs" class="block text-sm font-medium text-gray-700">Carboidratos (g)</label><input type="number" id="goalCarbs" class="mt-1 block w-full p-2 border rounded-md"></div>
                <div><label for="goalFat" class="block text-sm font-medium text-gray-700">Gorduras (g)</label><input type="number" id="goalFat" class="mt-1 block w-full p-2 border rounded-md"></div>
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button id="cancelGoalsBtn" class="px-6 py-2 rounded-lg text-gray-700 bg-gray-200 hover:bg-gray-300">Cancelar</button>
                <button id="saveGoalsBtn" class="px-6 py-2 rounded-lg text-white bg-teal-600 hover:bg-teal-700">Guardar Metas</button>
            </div>
        </div>
    </div>
    <!-- Modal de Entrada Manual -->
    <div id="manualEntryModal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-backdrop flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 m-4 max-w-lg w-full shadow-xl max-h-[90vh] flex flex-col">
             <h3 class="text-2xl font-bold mb-4">Adicionar Refei√ß√£o Manualmente</h3>
             <div class="space-y-3 overflow-y-auto pr-2">
                <input type="text" id="manualFoodName" class="w-full p-2 border rounded" placeholder="Nome da Refei√ß√£o (ex: Almo√ßo, Lanche)">
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" id="manualCalories" class="p-2 border rounded" placeholder="Total Calorias (kcal)">
                    <input type="number" id="manualProtein" class="p-2 border rounded" placeholder="Total Prote√≠nas (g)">
                    <input type="number" id="manualCarbs" class="p-2 border rounded" placeholder="Total Carboidratos (g)">
                    <input type="number" id="manualFat" class="p-2 border rounded" placeholder="Total Gorduras (g)">
                </div>
                <textarea id="manualFoodNotes" class="w-full p-2 border rounded" rows="3" placeholder="Notas ou alimentos espec√≠ficos (opcional)"></textarea>
             </div>
             <div class="flex justify-end space-x-4 mt-6 pt-4 border-t">
                <button id="cancelManualEntryBtn" class="px-6 py-2 rounded-lg text-gray-700 bg-gray-200 hover:bg-gray-300">Cancelar</button>
                <button id="saveManualEntryBtn" class="px-6 py-2 rounded-lg text-white bg-sky-600 hover:bg-sky-700">Adicionar ao Hist√≥rico</button>
             </div>
        </div>
    </div>
     <!-- Outros Modals (exclus√£o, edi√ß√£o) permanecem aqui... -->


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, doc, deleteDoc, updateDoc, setDoc, getDoc, where, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // ... O seu firebaseConfig vai aqui ...
     const firebaseConfig = {
  apiKey: "AIzaSyAuoQMjvRndLl1NtbhKnuvsBehtqmHW3Lo",
  authDomain: "nutriscan-app-d587e.firebaseapp.com",
  projectId: "nutriscan-app-d587e",
  storageBucket: "nutriscan-app-d587e.firebasestorage.app",
  messagingSenderId: "749495182083",
  appId: "1:749495182083:web:085d9580786d5c3e723f36"
};
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let unsubscribeHistory = null;
        let userGoals = { calories: 0, protein: 0, carbs: 0, fat: 0 };
        // ... Mapeamento de UI e outras vari√°veis globais ...

        const ui = {
            // ... Mapeamento de todos os elementos da UI, incluindo os novos ...
            openGoalsModalBtn: document.getElementById('openGoalsModalBtn'),
            goalsModal: document.getElementById('goalsModal'),
            cancelGoalsBtn: document.getElementById('cancelGoalsBtn'),
            saveGoalsBtn: document.getElementById('saveGoalsBtn'),
            goalInputs: {
                calories: document.getElementById('goalCalories'),
                protein: document.getElementById('goalProtein'),
                carbs: document.getElementById('goalCarbs'),
                fat: document.getElementById('goalFat'),
            },
            goalsProgress: document.getElementById('goalsProgress'),
            manualEntryButton: document.getElementById('manualEntryButton'),
            manualEntryModal: document.getElementById('manualEntryModal'),
            cancelManualEntryBtn: document.getElementById('cancelManualEntryBtn'),
            saveManualEntryBtn: document.getElementById('saveManualEntryBtn'),
            manualInputs: {
                name: document.getElementById('manualFoodName'),
                calories: document.getElementById('manualCalories'),
                protein: document.getElementById('manualProtein'),
                carbs: document.getElementById('manualCarbs'),
                fat: document.getElementById('manualFat'),
                notes: document.getElementById('manualFoodNotes'),
            },
            // Adicione os outros elementos da UI aqui para manter a organiza√ß√£o
        };
        
        // Event Listeners para novas funcionalidades
        ui.openGoalsModalBtn.addEventListener('click', openGoalsModal);
        ui.cancelGoalsBtn.addEventListener('click', () => ui.goalsModal.classList.add('hidden'));
        ui.saveGoalsBtn.addEventListener('click', saveGoals);
        ui.manualEntryButton.addEventListener('click', openManualEntryModal);
        ui.cancelManualEntryBtn.addEventListener('click', () => ui.manualEntryModal.classList.add('hidden'));
        ui.saveManualEntryBtn.addEventListener('click', saveManualEntry);


        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                // ... c√≥digo de login ...
                document.getElementById('main-content').classList.remove('hidden');
                document.getElementById('login-prompt').classList.add('hidden');
                loadUserSettings();
            } else {
                currentUser = null;
                // ... c√≥digo de logout ...
                if (unsubscribeHistory) unsubscribeHistory();
            }
        });

        async function loadUserSettings() {
            await fetchGoals();
            fetchAndDisplayTodaysHistory();
        }

        async function fetchGoals() {
            if (!currentUser) return;
            const goalsDocRef = doc(db, "users", currentUser.uid, "settings", "dailyGoals");
            const docSnap = await getDoc(goalsDocRef);
            if (docSnap.exists()) {
                userGoals = docSnap.data();
            } else {
                // Define metas padr√£o para novos utilizadores
                userGoals = { calories: 2000, protein: 120, carbs: 250, fat: 60 }; 
            }
            updateGoalsUIInputs();
        }
        
        function updateGoalsUIInputs() {
            if (!userGoals) return;
            ui.goalInputs.calories.value = userGoals.calories;
            ui.goalInputs.protein.value = userGoals.protein;
            ui.goalInputs.carbs.value = userGoals.carbs;
            ui.goalInputs.fat.value = userGoals.fat;
        }

        function openGoalsModal() {
            updateGoalsUIInputs();
            ui.goalsModal.classList.remove('hidden');
        }

        async function saveGoals() {
            if (!currentUser) return;
            const newGoals = {
                calories: parseInt(ui.goalInputs.calories.value) || 0,
                protein: parseInt(ui.goalInputs.protein.value) || 0,
                carbs: parseInt(ui.goalInputs.carbs.value) || 0,
                fat: parseInt(ui.goalInputs.fat.value) || 0,
            };
            const goalsDocRef = doc(db, "users", currentUser.uid, "settings", "dailyGoals");
            try {
                await setDoc(goalsDocRef, newGoals);
                userGoals = newGoals;
                ui.goalsModal.classList.add('hidden');
                // For√ßa a atualiza√ß√£o do painel de progresso com os novos valores
                fetchAndDisplayTodaysHistory(); 
            } catch (error) {
                console.error("Erro ao guardar metas:", error);
                // Adicionar feedback visual ao utilizador aqui
            }
        }
        
        function fetchAndDisplayTodaysHistory() {
            if (!currentUser) return;
            if (unsubscribeHistory) unsubscribeHistory();

            const todayStart = new Date();
            todayStart.setHours(0, 0, 0, 0);
            const todayEnd = new Date();
            todayEnd.setHours(23, 59, 59, 999);

            const q = query(collection(db, "users", currentUser.uid, "analyses"), 
                where("createdAt", ">=", Timestamp.fromDate(todayStart)),
                where("createdAt", "<=", Timestamp.fromDate(todayEnd)),
                orderBy("createdAt", "desc")
            );

            unsubscribeHistory = onSnapshot(q, (snapshot) => {
                const todaysTotals = { calories: 0, protein: 0, carbs: 0, fat: 0 };
                const historyList = document.getElementById('historyList'); // Definir aqui
                historyList.innerHTML = '';
                
                if (snapshot.empty) {
                    historyList.innerHTML = '<p class="text-center text-gray-500">Nenhuma refei√ß√£o registada hoje.</p>';
                }
                snapshot.forEach((doc) => {
                    const analysis = doc.data();
                    // Adiciona os totais
                    todaysTotals.calories += analysis.total_nutrition.calories;
                    todaysTotals.protein += analysis.total_nutrition.protein;
                    todaysTotals.carbs += analysis.total_nutrition.carbs;
                    todaysTotals.fat += analysis.total_nutrition.fat;
                    // Mostra o card no hist√≥rico (fun√ß√£o omitida por brevidade, mas existe)
                });
                updateProgressDashboard(todaysTotals);
            });
        }
        
        function updateProgressDashboard(totals) {
            ui.goalsProgress.innerHTML = '';
            const nutrients = [
                { key: 'calories', label: 'Calorias', color: 'orange' },
                { key: 'protein', label: 'Prote√≠nas', color: 'sky' },
                { key: 'carbs', label: 'Carboidratos', color: 'lime' },
                { key: 'fat', label: 'Gorduras', color: 'amber' }
            ];

            nutrients.forEach(n => {
                const total = Math.round(totals[n.key]);
                const goal = userGoals[n.key];
                const percentage = goal > 0 ? Math.min((total / goal) * 100, 100) : 0;
                
                const progressElement = document.createElement('div');
                progressElement.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm font-medium text-gray-700">${n.label}</span>
                        <span class="text-sm text-gray-500">${total} / ${goal}</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="bg-${n.color}-500 h-2.5 rounded-full progress-bar-fill" style="width: ${percentage}%"></div>
                    </div>
                `;
                ui.goalsProgress.appendChild(progressElement);
            });
        }
        
        function openManualEntryModal() {
            // Limpa os campos antes de abrir
            Object.values(ui.manualInputs).forEach(input => input.value = '');
            ui.manualEntryModal.classList.remove('hidden');
        }

        async function saveManualEntry() {
            if (!currentUser) return;
            const mealName = ui.manualInputs.name.value.trim() || "Refei√ß√£o Manual";
            const notes = ui.manualInputs.notes.value.trim() || "";
            const total_nutrition = {
                calories: parseInt(ui.manualInputs.calories.value) || 0,
                protein: parseInt(ui.manualInputs.protein.value) || 0,
                carbs: parseInt(ui.manualInputs.carbs.value) || 0,
                fat: parseInt(ui.manualInputs.fat.value) || 0,
            };

            const manualAnalysis = {
                total_nutrition,
                identified_foods: [{ name: mealName, grams: 0, notes, ...total_nutrition }],
                isManualEntry: true,
                createdAt: new Date(),
                userId: currentUser.uid,
            };

            try {
                await addDoc(collection(db, "users", currentUser.uid, "analyses"), manualAnalysis);
                ui.manualEntryModal.classList.add('hidden');
            } catch(error) {
                console.error("Erro ao guardar entrada manual: ", error);
            }
        }
        
        // As outras fun√ß√µes (handleImageUpload, analyzeImage, saveAnalysis, etc.) devem ser mantidas
        // para que a funcionalidade principal continue a funcionar.
        // O c√≥digo completo destas fun√ß√µes foi omitido aqui para focar nas novidades.
    </script>
</body>
</html>

